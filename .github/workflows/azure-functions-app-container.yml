# Questo workflow è ottimizzato per la distribuzione di un'immagine Docker
# su un'Azure Web App (App Service) su Linux.
name: Deploy container to Azure Web App (App Service)

on:
  push:
    branches: ["main"]

permissions:
  contents: read

env:
  # **************** AGGIORNARE QUESTI VALORI ****************
  AZURE_WEBAPP_NAME: 'SmartHomeAssistant'   # Il nome della tua Web App Azure
  LOGIN_SERVER: 'sampleappaoaichatgpt.azurecr.io' # Il tuo Azure Container Registry Login Server
  REGISTRY: 'sampleappaoaichatgpt.azurecr.io' # Il tuo Container Registry
  IMAGE_NAME: 'sample-app-aoai-chatgpt'       # Il nome dell'immagine nel tuo registro
  # **********************************************************
  
  # Non usare un namespace per l'ACR
  # Usa sempre il branch corrente come tag per avere un'immagine univoca e tracciabile
  TAG: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev # Puoi rimuovere questa riga se non usi ambienti GitHub
    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: 'Login via Azure CLI'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_RBAC_CREDENTIALS }}

    - name: 'Docker Login to ACR'
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.LOGIN_SERVER }}
        username: ${{ secrets.REGISTRY_USERNAME }} # Nome utente dal secret
        password: ${{ secrets.REGISTRY_PASSWORD }} # Password dal secret

    - name: 'Build and Push Docker Image'
      shell: bash
      run: |
        # Esegue il build dell'immagine con un tag univoco (hash del commit)
        docker build . -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}
        # Esegue il push dell'immagine nel tuo ACR
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}

    - name: 'Deploy to Azure Web App for Containers'
      uses: azure/webapps-deploy@v2 # <--- AZIONE DI DEPLOYMENT CORRETTA
      with:
        app-name: ${{ env.AZURE_WEBAPP_NAME }}
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.TAG }} # Usa il tag appena creato

    - name: Azure logout
      run: |
        az logout
